<!DOCTYPE html>
<meta charset="utf-8" />
<body>
  <p id="value"></p>
  <div id="slider">
    <button id="play-button">Play</button>
  </div>
  <div id="my_dataviz"></div>
</body>
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<script type="module">
  const weeksDataUrl =
    "https://raw.githubusercontent.com/6859-sp21/a4-musicovertheyears/main/weeks2010.json";
  const artistsDataUrl =
    "https://raw.githubusercontent.com/6859-sp21/a4-musicovertheyears/main/artists2010.json";
  const exampleDataUrl =
    "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_dendrogram_full.json";
  const duration = 1000
  d3.json(weeksDataUrl).then((weeks) => {
    d3.json(artistsDataUrl).then((artists) => {
    //////////////// SET UP CHART ///////////////////
    // 1. Set Data var
    //var date = "1/1/2011"
    //var data = weeks[date]
    //console.log(weeks)

    // 2. Setting up variables that describe our chart's space.
    const margin = { top: 10, right: 10, bottom: 10, left: 10 };
    const width = 1200 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Give the data to this cluster layout:

    function aggregateUniqueArtistsForWeek(data) {
      let uniqueArtists = {}
      for (let i = 0; i < data.length; i++){
        let artistID = data[i].artistID
        let score = Math.max(0, 11-data[i].position) // MODIFY THIS LINE
        if ( uniqueArtists.hasOwnProperty(artistID) ) {
          uniqueArtists[artistID] += score
        } else {
          if(score > 0) {
            //console.log(artistID)
            uniqueArtists[artistID] = score
          }
        }
      }
      /*
      const artistsList = Object.keys(artists)
      
      for (let i=0; i<artistsList.length; i++) {
        let myartist = artistsList[i]
        if(!(myartist in uniqueArtists)) {
          uniqueArtists[myartist] = 0
        }
      }*/

      let uniqueArtistsObjectsArray = []
      let uniqueColors = []
      for (const property in uniqueArtists) {
        uniqueArtistsObjectsArray.push({"artistID": property, "score": uniqueArtists[property]})
        uniqueColors.push('#'+(Math.random() * 0xFFFFFF << 0).toString(16).padStart(6, '0'))
      }

      return uniqueArtistsObjectsArray
    }

    // append the svg object to the body of the page
    var svg = d3
      .select("#my_dataviz")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // use this information to add rectangles:
    // svg
    //   .selectAll("rect")
    //   .data(root.leaves())
    //   .enter()
    //   .append("rect")
    //     .attr('x', function (d) { return d.x0; })
    //     .attr('y', function (d) { return d.y0; })
    //     .attr('width', function (d) { return d.x1 - d.x0; })
    //     .attr('height', function (d) { return d.y1 - d.y0; })
    //     .style("stroke", "black")
    //     .style("fill", function (d) {  return color(d.data.artistID) })

    // and to add the text labels
    // svg
    //   .selectAll("text")
    //   .data(root.leaves())
    //   .enter()
    //   .append("text")
    //     .attr("x", function(d){ return d.x0+5})    // +10 to adjust position (more right)
    //     .attr("y", function(d){ return d.y0+20})    // +20 to adjust position (lower)
    //     .text(function(d){ return d.data.score })
    //     .attr("font-size", "15px")
    //     .attr("fill", "white")

    var currentDate = "1/1/2011"
    var treeData = {"children": [],"name":"tree"}
   
    // Here the size of each leave is given in the 'score' field in input data
    var displayedArtists = []
    var root;

    function updateTreemapFromDate(date) {
      //const data = aggregate_Histo(rawData);
      // console.log(data);
      console.log(date)
      currentDate = date 
      var data = weeks[date]

      var uniqueArtists = aggregateUniqueArtistsForWeek(data.artists)

      treeData = {"children": uniqueArtists,"name":"tree"}
      // Here the size of each leave is given in the 'score' field in input data
      root = d3.hierarchy(treeData).sum(function(d){
          return d.score
      }) 
      d3.treemap()
        .tile(d3.treemapResquarify)
        .size([width, height])
        .padding(2)
        (root) 
      displayedArtists = root.children 
     // console.log(displayedArtists)
      svg
        .selectAll("image")
        .data(displayedArtists, function(d, i) { console.log(d.data.artistID); return d.data.artistID })
        .join(
          enter => enter/*.append("rect")
              .attr('x', function (d) { return d.x0; })
              .attr('y', function (d) { return d.y0; })
              .attr('width', function (d) { return d.x1 - d.x0; })
              .attr('height', function (d) { return d.y1 - d.y0; })
              .style("stroke", "black")*/
              .append('svg:image')
              .attr('xlink:href', function (d) { return artists[d.data.artistID].images[0].url})
              
              
              .attr("preserveAspectRatio", "xMinYMin slice")
              .call(enter => enter.transition().duration(duration)
              .attr('width', function (d) { return d.x1 - d.x0; })
              .attr('height', function (d) { return d.y1 - d.y0; })
              .attr("x", function (d) { return d.x0; })
              .attr("y", function (d) { return d.y0; })
              ),
              //.style("fill", function (d) {  return color(d.data.artistID) }),
          
          update => update
              
              .call(update => update.transition().duration(duration)
              .attr('width', function (d) { return d.x1 - d.x0; })
              .attr('height', function (d) { return d.y1 - d.y0; })
              .attr('x', function (d) { return d.x0; })
              .attr('y', function (d) { return d.y0; })
              ),
              //.style("stroke", "black"),
          
          exit => exit.call(exit => exit.transition().duration(duration)
          .attr('width', 0)
          .attr('height', 0)

          )
          
          .remove()
              //.style("fill", function (d) {  return color(d.data.artistID) }),
        );
    }
    updateTreemapFromDate(currentDate)
    

      // Then d3.treemap computes the position of each element of the hierarchy
      
      //let color = d3.scaleOrdinal()
      //  .domain(uniqueArtistsArray)
      //  .range(uniqueColors);


      
        

    






    const dateRange = [...Array(474).keys()].map(function (d) {
      return new Date(2011, 0, 1+(d*7));
    });
   

    var moving = false
    var timer = 0 
    var slider = d3
      .sliderHorizontal()
      .min(d3.min(dateRange))
      .max(d3.max(dateRange))
      //.step(1000 * 60 * 60 * 24 * 365)
      .step(1000 * 60 * 60 * 24 * 7)
      .width(width-100)
      .tickFormat(d3.timeFormat('%d %b %Y'))
      .ticks(10)
      //.default(0.015);
      //.default(new Date(2019, 10, 3));
      .on("onchange", (val) => {
        var newDate = String(val.getMonth()+1) + "/" + String(val.getDate()) + "/" + String(val.getFullYear())
        //console.log(data)
        updateTreemapFromDate(newDate)
      })

    var playButton = d3.select("#play-button");
    playButton
    .on("click", function() {
    var button = d3.select(this);
    if (button.text() == "Pause") {
        moving = false;
        clearInterval(timer);
        // timer = 0;
        button.text("Play");
      } else {
        moving = true;
        timer = setInterval(nextWeek, 2000);
        button.text("Pause");
      }
      console.log("Slider moving: " + moving);
    })

    function nextWeek() {
      //console.log(currentDate)
      let val = new Date((new Date(currentDate).getTime()) + 7*24*60*60*1000);
      // make sure right day of week 
      val.setDate(val.getDate() + (6 - val.getDay()))
      console.log(val.getDay())
      if (val > d3.max(dateRange)) {
        moving = false;
        val = d3.min(dateRange);
        
        clearInterval(timer);
        playButton.text("Play");
        console.log("Slider moving: " + moving);
      }
      slider.value(val)
      currentDate = String(val.getMonth()+1) + "/" + String(val.getDate()) + "/" + String(val.getFullYear())
      updateTreemapFromDate(currentDate)
    }


    d3.select("#slider")
      .append("svg")
      .attr("width", width)
      .attr("height", 100)
      .append("g")
      .attr("transform", "translate(30,30)")
      .call(slider);

    
  });
});
</script>
