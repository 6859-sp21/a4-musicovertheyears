<!DOCTYPE html>
<meta charset="utf-8" />
<body>
  <div id="slider"></div>
  <div id="my_dataviz"></div>
</body>
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<script type="module">
  const weeksDataUrl =
    "https://raw.githubusercontent.com/6859-sp21/a4-musicovertheyears/main/weeks2010.json";
  const exampleDataUrl =
    "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_dendrogram_full.json";

  d3.json(weeksDataUrl).then((result) => {

    //////////////// SET UP CHART ///////////////////
    // 1. Set Data var
    var date = "1/1/2011"
    var data = result[date]
    //console.log(data)

    // 2. Setting up variables that describe our chart's space.
    const margin = { top: 10, right: 10, bottom: 10, left: 10 };
    const width = 900 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3
      .select("#my_dataviz")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Give the data to this cluster layout:

    function aggregateUniqueArtistsForWeek(data) {
      let uniqueArtists = {}
      for (let i = 0; i < data.length; i++){
        let artistId = data[i].artistID
        if ( uniqueArtists.hasOwnProperty(artistId) ) {
          uniqueArtists[artistId] += data[i].score
        } else {
          uniqueArtists[artistId] = data[i].score
        }
      }

      let uniqueArtistsObjectsArray = []
      let uniqueColors = []
      for (const property in uniqueArtists) {
        uniqueArtistsObjectsArray.push({"artistId": property, "score": uniqueArtists[property]})
        uniqueColors.push('#'+(Math.random() * 0xFFFFFF << 0).toString(16).padStart(6, '0'))
      }

      return [uniqueArtistsObjectsArray, Object.getOwnPropertyNames(uniqueArtists), uniqueColors]
    }

    var [uniqueArtists, uniqueArtistsArray, uniqueColors] = aggregateUniqueArtistsForWeek(data.artists)

    //console.log(uniqueArtists)
    //console.log(uniqueArtistsArray)
    //console.log(uniqueColors)

    var treeData = {"children": uniqueArtists,"name":"tree"}
    //console.log(treeData)

    var root = d3.hierarchy(treeData).sum(function(d){return d.score}) // Here the size of each leave is given in the 'value' field in input data

    // Then d3.treemap computes the position of each element of the hierarchy
    d3.treemap()
      .size([width, height])
      .padding(2)
      (root)

    let color = d3.scaleOrdinal()
      .domain(uniqueArtistsArray)
      .range(uniqueColors);

    // use this information to add rectangles:
    svg
      .selectAll("rect")
      .data(root.leaves())
      .enter()
      .append("rect")
        .attr('x', function (d) { return d.x0; })
        .attr('y', function (d) { return d.y0; })
        .attr('width', function (d) { return d.x1 - d.x0; })
        .attr('height', function (d) { return d.y1 - d.y0; })
        .style("stroke", "black")
        .style("fill", function (d) {  return color(d.data.artistId) })

    // and to add the text labels
    svg
      .selectAll("text")
      .data(root.leaves())
      .enter()
      .append("text")
        .attr("x", function(d){ return d.x0+5})    // +10 to adjust position (more right)
        .attr("y", function(d){ return d.y0+20})    // +20 to adjust position (lower)
        .text(function(d){ return d.data.score })
        .attr("font-size", "15px")
        .attr("fill", "white")

    var slider = d3
      .sliderHorizontal()
      .min(0)
      .max(10)
      .step(1)
      .width(width-50)
      .displayValue(false)
      .on("onchange", (val) => {
        d3.select("#value").text(val);
      });

    d3.select("#slider")
      .append("svg")
      .attr("width", width)
      .attr("height", 100)
      .append("g")
      .attr("transform", "translate(30,30)")
      .call(slider);
  });
</script>
